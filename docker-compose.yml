services:
  n8n:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: n8n-video-repurpose
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Basic Configuration
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}
      
      # Security
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-changeme}
      
      # Execution Settings
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_TIMEOUT=3600
      - EXECUTIONS_TIMEOUT_MAX=7200
      
      # Database (SQLite for simplicity, use Postgres for production)
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite
      
      # Timezone
      - GENERIC_TIMEZONE=Asia/Ulaanbaatar
      - TZ=Asia/Ulaanbaatar
      
      # File handling
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      
      # Enable all nodes and env access
      - N8N_REINSTALL_MISSING_PACKAGES=true
      - NODE_FUNCTION_ALLOW_EXTERNAL=*
      - NODE_FUNCTION_ALLOW_BUILTIN=*
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      
      # Cloudflare R2 Settings (set your actual values)
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-your-account-id}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-your-bucket-name}
      
    volumes:
      # n8n data persistence
      - n8n_data:/home/node/.n8n
      
      # Shared data directory for video processing
      - ./data:/data
      
      # Custom credentials file (optional)
      - ./credentials:/home/node/.n8n/credentials
      
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  n8n_data:
    driver: local

networks:
  default:
    name: n8n-network

